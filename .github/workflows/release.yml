name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binaries
        run: |
          cargo build --release -p server
          cargo build --release -p agent
          cargo build --release -p tui
          mkdir -p dist
          cp target/release/server dist/rustploy-server
          cp target/release/agent dist/rustploy-agent
          cp target/release/tui dist/rustploy-tui

      - name: Generate checksums
        run: |
          cd dist
          sha256sum rustploy-server rustploy-agent rustploy-tui > SHA256SUMS

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: ./dist
          format: spdx-json
          output-file: dist/sbom.spdx.json

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: "dist/*"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/rustploy-server
            dist/rustploy-agent
            dist/rustploy-tui
            dist/SHA256SUMS
            dist/sbom.spdx.json
