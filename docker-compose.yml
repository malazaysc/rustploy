services:
  sqlite:
    image: busybox:1.36
    command: ["sh", "-c", "tail -f /dev/null"]
    volumes:
      - rustploy-data:/data

  server:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_BIN: server
    environment:
      RUSTPLOY_SERVER_ADDR: 0.0.0.0:8080
      RUSTPLOY_DB_PATH: /data/rustploy.db
      RUSTPLOY_RUNTIME_ROOT: /data/runtime
      RUSTPLOY_CADDYFILE_PATH: /shared/Caddyfile
      RUSTPLOY_UPSTREAM_ADDR: server:8080
      RUSTPLOY_ADMIN_EMAIL: admin@localhost
      RUSTPLOY_ADMIN_PASSWORD: admin
      # RUSTPLOY_AGENT_TOKEN: change-me
      # RUSTPLOY_GITHUB_WEBHOOK_SECRET: change-me
    volumes:
      - rustploy-data:/data
      - rustploy-shared:/shared
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - sqlite

  agent:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_BIN: agent
    environment:
      RUSTPLOY_SERVER_ADDR: server:8080
      RUSTPLOY_HEARTBEAT_INTERVAL_SECS: 10
      # RUSTPLOY_AGENT_TOKEN: change-me
    depends_on:
      - server
    restart: unless-stopped

  caddy:
    image: caddy:2.8
    command:
      [
        "sh",
        "-c",
        "until [ -f /shared/Caddyfile ]; do sleep 1; done; exec caddy run --watch --config /shared/Caddyfile --adapter caddyfile"
      ]
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - rustploy-shared:/shared:ro
      - rustploy-caddy:/data
      - rustploy-caddy-config:/config
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - server
    restart: unless-stopped

volumes:
  rustploy-data:
  rustploy-shared:
  rustploy-caddy:
  rustploy-caddy-config:
